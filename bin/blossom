#!/usr/bin/env ruby

require 'fileutils'
require "#{File.dirname(__FILE__)}/../lib/blossom"

include FileUtils

def make_file(name, content)
  File.open(name, "w") { |file| file.write(content) }
end

def usage
  "Usage: #$0 PROJECT-NAME"
end

def die(message)
  error message
  exit 1
end

def error(message)
  warn "Blossom: Error: #{message}"
end

def run(command)
  puts "$ #{command}"
  system command or die "Command failed: #{command}"
end

if ARGV.empty?
  print usage
elsif ARGV[0].start_with? "-"
  case ARGV[0]
  when "--version", "-v"
    puts Blossom::VERSION
  when "--help", "-h", "-?"
    print usage
  else
    error "Unrecognized option: #{ARGV[0]}"
    warn usage
    exit 1
  end
else
  name = ARGV.first
  name_symbol = name =~ /\W|^\d/ ? ":'#{name}'" : ":#{name}"

  if File.exist? name
    die "File already exists: #{name}"
  else
    puts "Blossom creating project: #{name}"

    puts "$ mkdir #{name}; cd #{name}"
    mkdir name; cd name

    puts "Installing Blossom boilerplate."

    make_file ".gitignore", "tmp\n"

    make_file "config.ru", <<"^D"
require "rubygems"
require "bundler/setup"
require "blossom"

run Blossom __FILE__, #{name_symbol},
  # :strip_www? => false,
  :cache => [1, :day]
^D

    make_file "Gemfile", <<"^D"
source :rubygems

gem 'blossom', '~> #{Blossom::VERSION}'

## Uncomment the following if you want to use CoffeeScript.
## (See further instructions in #{name}.js.)
# gem 'rack-coffee'
^D

    make_file "#{name}.haml", <<"^D"
!!!
%html
  %head
    %meta(charset="utf-8")
    %title #{name.capitalize}
    %meta(name="description" content="Description of #{name.capitalize}.")
    %link(rel="stylesheet" href="#{name}.css")
    %script(src="#{name}.js")
  %body
    %h1 This is <tt>#{name}.haml</tt>.
^D

    make_file "#{name}.sass", <<"^D"
@import compass/reset

body
  width: 600px
  margin: auto

h1
  font: 200 40px "Helvetica Neue", Helvetica
  margin-top: 80px
^D

    make_file "#{name}.rb", <<"^D"
# Put any custom Sinatra routes you need here.

# get '/hello' do
#   "Hello World"
# end
^D

    make_file "#{name}.js", <<"^D"
// If you do not want to use CoffeeScript, you can delete this comment.
// If you do, first install the CoffeeScript compiler and Rack::Coffee:
//
//    $ npm install -g coffee-script
//    $ gem install rack-coffee
//    $ echo "gem 'rack-coffee'" >> Gemfile
//    $ bundle
//
// Then simply delete this file and create #{name}.coffee instead.
^D

    mkdir "static"

    run "bundle --local"
    run "git init"
    run "git add -A"
    run "git commit -m 'Create project.'"
    
    puts <<"^D"

Application created!  Now type \`cd #{name}\' and then \`rackup\'.
This will run your application at <http://localhost:9292/>.

Start hacking in \`#{name}.haml\' and \`#{name}.sass\'.  If you
create \`x.haml\', it will show up at <http://localhost:9292/x>.

Images and other static files go in the \`static/\' directory, but
you can put Javascript files in the root directory if you want.
If you prefer CoffeeScript, follow the instructions in \`#{name}.js\'.

Your custom Sinatra routes, if you need any, go in \`#{name}.rb\'.
In production, your site is cached; configure this in \`config.ru\'.

Good luck and have fun! :-)
^D
  end
end
