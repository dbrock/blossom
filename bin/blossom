#!/usr/bin/env ruby

require "fileutils"
require "#{File.dirname(__FILE__)}/../lib/blossom"

include FileUtils

def make_file(name, content)
  File.open(name, "w") { |file| file.write(content) }
end

def usage
  "Usage: #$0 PROJECT-NAME"
end

def die(message)
  error message
  exit 1
end

def error(message)
  warn "Blossom: Error: #{message}"
end

def run(command)
  puts "$ #{command}"
  system command or die "Command failed: #{command}"
end

if ARGV.empty?
  print usage
elsif ARGV[0].start_with? "-"
  case ARGV[0]
  when "--version", "-v"
    puts Blossom::VERSION
  when "--help", "-h", "-?"
    print usage
  else
    error "Unrecognized option: #{ARGV[0]}"
    warn usage
    exit 1
  end
else
  name = ARGV.first
  name_symbol = name =~ /\W|^\d/ ? ":'#{name}'" : ":#{name}"
  name_pretty = name.capitalize.gsub(/[-_]/, " ")

  if File.exist? name
    die "File already exists: #{name}"
  else
    puts "Blossom creating project: #{name}"

    puts "$ mkdir #{name}; cd #{name}"
    mkdir name; cd name

    puts "Installing Blossom boilerplate."

    make_file "#{name}.blossom", <<"^D"
Content-Max-Age: 1 day
# Normalize-Domains: no
^D

    make_file ".gitignore", "tmp\n"

    make_file "config.ru", <<"^D"
require "rubygems"
require "bundler/setup"
require "blossom"

# You can insert any middleware you need here (just remember to add
# any new dependencies to your Gemfile and to run \`bundle\'):
#
# require "some/other/middleware"
# use Some::Other::Middleware

run Blossom __FILE__

# If you need to use Blossom when configuring some other middleware,
# you have to save a reference to the Blossom application first:
#
# blossom = Blossom __FILE__
# use Some::Other::Middleware, :sass_options => blossom.sass_options
# run blossom
^D

    make_file "Gemfile", <<"^D"
source :rubygems

gem "blossom", "~> #{Blossom::VERSION}"

# Uncomment the following if you want to use CoffeeScript.
# (See further instructions in #{name}.js.)
#
# gem "rack-coffee"
^D

    make_file "#{name}.haml", <<"^D"
!!!
%html
  %head
    %meta(charset="utf-8")
    %title #{name_pretty}
    %meta(name="description" content="Description of #{name_pretty}.")
    %link(rel="stylesheet" href="#{name}.css")
    %script(src="#{name}.js")
  %body
    %h1 This is <tt>#{name}.haml</tt>.
^D

    make_file "#{name}.sass", <<"^D"
@import compass/reset

body
  width: 600px
  margin: auto

h1
  font: 200 40px/1.5 "Helvetica Neue", Helvetica
  margin-top: 80px
^D

    make_file "#{name}.sinatra.rb", <<"^D"
# Put any custom Sinatra routes or configuration here.
# See <http://www.sinatrarb.com/documentation> for help.

# get "/hello" do
#   "Hello World"
# end
^D

    make_file "#{name}.js", <<"^D"
// If you do not want to use CoffeeScript, you can delete this comment.
// If you do, first install the CoffeeScript compiler and Rack::Coffee:
//
//    $ npm install -g coffee-script
//    $ gem install rack-coffee
//    $ echo 'gem "rack-coffee"' >> Gemfile
//    $ bundle
//
// Then simply delete this file and create #{name}.coffee instead.
^D

    mkdir "static"

    run "bundle --local"
    run "git init"
    run "git add -A"
    run "git commit -m 'Create project.'"
    
    puts <<"^D"

Application created!  Now type \`cd #{name}\' and then \`rackup\'.
This will run your application at <http://localhost:9292/>.

Start hacking in \`#{name}.haml\' and \`#{name}.sass\'.  If you
create \`x.haml\', it will show up at <http://localhost:9292/x>.

Images and other static files go in the \`static/\' directory, but
you can put Javascript files in the root directory if you want.
If you prefer CoffeeScript, follow the instructions in \`#{name}.js\'.

Put any custom Sinatra routes you need in \`#{name}.sinatra.rb\'.
Configuration of Blossom is done in \`#{name}.blossom\'.

Good luck and have fun! :-)
^D
  end
end
